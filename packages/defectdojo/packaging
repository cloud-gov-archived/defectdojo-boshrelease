#!/bin/bash
set -eo pipefail

# See the upstream Dockerfile for the source of these packaging steps:
# https://github.com/DefectDojo/django-DefectDojo/blob/master/Dockerfile.django-debian

# blob source: https://github.com/DefectDojo/django-DefectDojo/archive/refs/tags/2.25.4.tar.gz
mkdir -p source
tar -xzf defectdojo/2.25.4.tar.gz -C source # result: source/django-DefectDojo-2.25.4
ls source | xargs -I% cp -r source/%/. $BOSH_INSTALL_TARGET
cd $BOSH_INSTALL_TARGET

export LD_LIBRARY_PATH=/var/vcap/packages/python/lib:$LD_LIBRARY_PATH
export C_INCLUDE_PATH=/var/vcap/packages/python/include:$C_INCLUDE_PATH
export PATH=/var/vcap/packages/python/bin:$PATH

python3 --version

DEBIAN_FRONTEND=noninteractive apt-get -y update && apt-get -y install \
  apt-transport-https \
  libjpeg-dev \
  gcc \
  libssl-dev \
  yarn \
  build-essential \
  expect \
  libcurl4-openssl-dev \
  libmysqlclient-dev \
  libpq-dev \
  postgresql \
  postgresql-contrib \
  postgresql-client-common \
  postgresql-client-14 \
  git \

virtualenv --always-copy venv
. venv/bin/activate

CPUCOUNT=1 pip3 wheel --wheel-dir=/tmp/wheel -r ./requirements.txt

pip3 --version
pip3 install --no-cache-dir \
  --no-index \
  --find-links=/tmp/wheel \
  -r requirements.txt


deactivate
sed -i 's/^\(VIRTUAL_ENV\)=.\+$/\1="\/var\/vcap\/packages\/defectdojo\/venv"/g' venv/bin/activate
