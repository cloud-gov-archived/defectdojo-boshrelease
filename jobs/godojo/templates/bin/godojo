#!/bin/bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

cd /var/vcap/jobs/godojo/django-DefectDojo

#use godojo env
source /var/vcap/jobs/godojo/bin/activate

export DD_CSRF_TRUSTED_ORIGINS="https://dojo-beta.dev.us-gov-west-1.aws-us-gov.cloud.gov"

#start celery workers
C_FORCE_ROOT="true" celery -A dojo worker -l info --concurrency 3 &

# Startup the Celery beat process
C_FORCE_ROOT="true" celery --app dojo beat -l info &

# Startup DefectDojo on port 8081
uwsgi --http :8081 --module dojo.wsgi
