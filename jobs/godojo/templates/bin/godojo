#!/bin/bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

cd /var/vcap/jobs/godojo/django-DefectDojo

#start celery workers
screen -S worker -D -m /bin/bash -c 'source /var/vcap/jobs/godojo/bin/activate && C_FORCE_ROOT="true" celery -A dojo worker -l info --concurrency 3' &

# Startup the Celery beat process
screen -S beat -D -m /bin/bash -c 'source /var/vcap/jobs/godojo/bin/activate && C_FORCE_ROOT="true" celery --app dojo beat -l info' &

# Startup DefectDojo with 'runserver' on port 8080
screen -S dojo -D -m /bin/bash -c 'source /var/vcap/jobs/godojo/bin/activate && python manage.py runserver 0.0.0.0:8080' &

echo "DefectDojo should now be available on port 8080 e.g. http://127.0.0.1:8080 or http://[your IP or hostname]:8080"
